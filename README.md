## RU

# Airbnb парсер

**Что делает:** Парсер данных сайта Airbnb на python библиотеках Beautiful Soup 4 и Selenium. Собранные данные размещает в реляционной базе данных PostgreSQL. Так же задумана аналитика данных - допишу позже.

**Готовность:** Собирает, вносит в базу.

**Как запустить:** На данный момент еще не все готово. Запускается Docker-compose - база данных. И просто запускается файл python. Для запуска:

- Колонировать репозиторий себе

- Установить виртуальное окружение в эту папку, запустить

- В файле Dockerfile все раскоментировать - это установить все библиотеки через pip при запуске контейнера. В файле requirements.txt много лишнего, позже почищу.

- Поднять docker-compose up --build. Установятся связи. Запуститься база.

- В терминале выполнить "alembic upgrade head" - это создаст таблице в базе. Можно это не делать, при первом обращении к базе - это должно произойти автоматически, но в этом случае возможна ошибка.

- Просто запустить файл get_rooms_airbnb.py (скорее всего - это измениться, пока что так)



# Подробное описание приложения

- Парсер собирает данные по всем rooms зданной локации, например Bali и заносит в базу данных. Из всех данных, основным элементом является id room. ID участвует почти веде - это уникальный номер сдаваемого места. Он же в ссылке на room, в картинке, в title url.. Так же, присваевается каждой записи rooms location, дата обновления записи. При повторном парсинге, парсер сверяеет полученный id с наличием его в базе и если давность обновления равно или больше 1 часа, то переписывает. 

- После сбора rooms, парсер забирает из базы или все id, или локации, возможно по карте локаций (еще подумаю). Храня забраные id, он по каждому id забирает url каждой записи ведущей к подробной информации объекта - room. Парсер посещает эту страницу, забирает все что нужно и дополняет запись столбцами и переходит к следующему id. И так далее до окончания id или локаций. Я думаю, что запуск парсера для обновления данных будет происходить по запросу пользователя, возможно путем постстроения таски на это по времени. При выполнении обхода, скорее всего будет передаваться сообщение на телеграмм бота с подробностями обхода. Пока, что задумывается так, по ходу посмотрим. Большая часть уже работает и выполняется.

- Я думаю нужно сделать словарь подгружаемых элементов html которые нужно собирать. Что бы это было не в дебрях кода, а подгружаемо простым словарем. Так как настройки парсера не долговечны. Сайт обновят и все придется заново настраивать, так пусть это будет хотя бы просто и удобно.

 - Сайт не отдает данные через Beautiful Soup 4, так как генерирует и наполняет сайт данными видимо скриптом. Если использовать driver Selenium и скрабить BS4 то вроде норм. Но после перехода на url драйвером, нужно дать пару секунд на догрузку и можно снимать html. 

- Иногда на главной странице происходит блокирование - Access Denied, но если пошаманить с опциями драйвера хрома селениума, то все вроде ок. Не знаю как будет дальше с блокировками роботов, но попробую сделать помаксимуму похожий скрабер с пользователем.

- После доработок работы парсера, ошибок не возникает и сервер максимально отзывчев. Обращение не блокирует, даже, если довольно долго его парсить. Хотя почти везде установлены случайные задержки в дробных числах. Так же заморочился с подменой user-agent, максимально-возможно скрыл доступные способы скрытия фингерпринта железа. 10 профилей, хоть и пустых chrome driver. При необходимости, можно будет подразвить и вообще подключить proxy. Но я не думаю, что в ближайшее время сервер доростет до борьбы с этим парсером, посмотрим. Так же есть возможность использовать режим драйвера хрома headless. Браузер не будет запускаться до конца, т. е. не будет визуальной части браузера, но все будет работать и нормально парсить.

# База данных

Используется асинхронная база данных PostgreSQL. Парсер синхронный. Но возможно, асинхронность базы понадобиться.

1. **Rooms** - таблица, где основным ключем для всех связей будет **room_id** места или объекта в Airbnb.

2. **Task** - Таблица с назначеными задачами.

3. **Users** - Таблица, где будут настройки и уровни доступа пользователей приложением, при его возможном расширении.



## EN